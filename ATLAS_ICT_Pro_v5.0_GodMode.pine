// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© ATLAS Trading - God Mode v5.0
// CORTEX-POWERED: All ICT concepts derived from 20,833 knowledge chunks from 672 transcripts

//@version=5
indicator("ATLAS ICT Pro v5.0 - GOD MODE [PAC-MAN EDITION]", overlay=true, max_lines_count=500, max_boxes_count=500, max_labels_count=500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ® PAC-MAN GOD MODE - THE CORTEX KNOWS ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// This indicator uses ALL ICT concepts from The Cortex (672 transcripts) to
// determine the most probable Draw on Liquidity (DOL) path.
//
// PAC-MAN TERMINOLOGY:
// ğŸŸ¡ PAC-MAN = Price Action (you are the trader following the path)
// ğŸ‘» GHOSTS = Institutional Players / Smart Money hunting stops
// âš« PELLET = Small liquidity (BSL/SSL - equal highs/lows)
// ğŸ”´ POWER PELLET = Major liquidity (EQH/EQL clusters, swing points)
// ğŸ’ CHERRY = PWH/PWL (Previous Week High/Low)
// ğŸŒ€ SPAWN ZONE = OTE Retracement (62-79% fib zone)
// ğŸš‡ TUNNEL = FVG (Fair Value Gap - imbalance to fill)
// ğŸ BONUS = NWOG CE (New Week Opening Gap Consequent Encroachment)
// ğŸšª EXIT = CBDR Standard Deviation projections
// ğŸ¯ MAZE PATH = Draw on Liquidity direction
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                           USER INPUTS                                          â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOD MODE SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_god = "ğŸ® GOD MODE (DOL Engine)"
i_showDOL = input.bool(true, "Show DOL Path (Pac-Man Maze)", group=grp_god)
i_showDOLTable = input.bool(true, "Show DOL Probability Dashboard", group=grp_god)
i_showPacMan = input.bool(true, "Show Pac-Man Visuals", group=grp_god)
i_dolSensitivity = input.string("Medium", "DOL Sensitivity", options=["Low", "Medium", "High"], group=grp_god)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HTF BIAS SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_htf = "ğŸ“Š HTF BIAS"
i_htfBias = input.bool(true, "Enable HTF Bias Filter", group=grp_htf)
i_htfTimeframe = input.timeframe("240", "HTF Timeframe", group=grp_htf)
i_htfLookback = input.int(20, "HTF Swing Lookback", minval=5, maxval=50, group=grp_htf)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TURTLE SOUP SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_ts = "ğŸ¢ TURTLE SOUP"
i_showTurtleSoup = input.bool(true, "Show Turtle Soup Setups", group=grp_ts)
i_tsLookback = input.int(20, "Turtle Soup Lookback", minval=5, maxval=100, group=grp_ts)
i_tsBuffer = input.float(0.0, "Turtle Soup Buffer (ticks)", minval=0, group=grp_ts)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JUDAS SWING SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_judas = "ğŸ­ JUDAS SWING"
i_showJudas = input.bool(true, "Show Judas Swing", group=grp_judas)
i_judasSession = input.session("0200-0500", "Judas Session (NY Time)", group=grp_judas)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ORDER BLOCK SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_ob = "ğŸ“¦ ORDER BLOCKS"
i_showOB = input.bool(true, "Show Order Blocks", group=grp_ob)
i_obLookback = input.int(50, "OB Lookback", minval=10, maxval=200, group=grp_ob)
i_obMitigation = input.string("Wick", "OB Mitigation Type", options=["Wick", "Close", "Avg"], group=grp_ob)
i_obMaxAge = input.int(100, "Max OB Age (bars)", minval=10, maxval=500, group=grp_ob)
i_obShowLifecycle = input.bool(true, "Show OB Lifecycle Labels", group=grp_ob)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FVG/IFVG SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_fvg = "âš¡ FVG / IFVG"
i_showFVG = input.bool(true, "Show Fair Value Gaps", group=grp_fvg)
i_showIFVG = input.bool(true, "Show Inverse FVG (IFVG)", group=grp_fvg)
i_fvgMitigation = input.string("50%", "FVG Mitigation Level", options=["25%", "50%", "75%", "100%"], group=grp_fvg)
i_fvgMinSize = input.float(0.0, "Min FVG Size (ticks)", minval=0, group=grp_fvg)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BREAKER / MITIGATION / REJECTION BLOCKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_blocks = "ğŸ§± BREAKER / MIT / REJ BLOCKS"
i_showBreaker = input.bool(true, "Show Breaker Blocks", group=grp_blocks)
i_showMitBlock = input.bool(true, "Show Mitigation Blocks", group=grp_blocks)
i_showRejBlock = input.bool(true, "Show Rejection Blocks", group=grp_blocks)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIQUIDITY SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_liq = "ğŸ’§ LIQUIDITY"
i_showBSL = input.bool(true, "Show Buy Side Liquidity (BSL)", group=grp_liq)
i_showSSL = input.bool(true, "Show Sell Side Liquidity (SSL)", group=grp_liq)
i_showEQH = input.bool(true, "Show Equal Highs", group=grp_liq)
i_showEQL = input.bool(true, "Show Equal Lows", group=grp_liq)
i_eqThreshold = input.float(0.1, "Equal H/L Threshold %", minval=0.01, maxval=1.0, group=grp_liq)
i_liqLookback = input.int(50, "Liquidity Lookback", minval=10, maxval=200, group=grp_liq)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IPDA LOOKBACK SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_ipda = "ğŸ“ˆ IPDA DATA RANGES"
i_showIPDA = input.bool(true, "Show IPDA Levels", group=grp_ipda)
i_ipda20 = input.bool(true, "20-Day IPDA", group=grp_ipda)
i_ipda40 = input.bool(true, "40-Day IPDA", group=grp_ipda)
i_ipda60 = input.bool(true, "60-Day IPDA", group=grp_ipda)
i_showPWHL = input.bool(true, "Show Previous Week H/L", group=grp_ipda)
i_showPMHL = input.bool(true, "Show Previous Month H/L", group=grp_ipda)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CBDR SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_cbdr = "ğŸ¦ CBDR (Central Bank Dealers Range)"
i_showCBDR = input.bool(true, "Show CBDR", group=grp_cbdr)
i_cbdrSession = input.session("1400-2000", "CBDR Session (NY Time)", group=grp_cbdr)
i_cbdrSD = input.float(2.5, "CBDR SD Multiplier", minval=0.5, maxval=5.0, step=0.5, group=grp_cbdr)
i_showCBDRProjections = input.bool(true, "Show SD Projections", group=grp_cbdr)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NWOG SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_nwog = "ğŸ“… NWOG (New Week Opening Gap)"
i_showNWOG = input.bool(true, "Show NWOG", group=grp_nwog)
i_showNWOGCE = input.bool(true, "Show NWOG Consequent Encroachment", group=grp_nwog)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKET STRUCTURE SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_ms = "ğŸ“ MARKET STRUCTURE"
i_showMS = input.bool(true, "Show Market Structure", group=grp_ms)
i_showBOS = input.bool(true, "Show BOS (Break of Structure)", group=grp_ms)
i_showCHoCH = input.bool(true, "Show CHoCH (Change of Character)", group=grp_ms)
i_msLookback = input.int(20, "MS Swing Lookback", minval=5, maxval=50, group=grp_ms)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREMIUM/DISCOUNT SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_pd = "âš–ï¸ PREMIUM / DISCOUNT"
i_showPDZones = input.bool(true, "Show Premium/Discount Zones", group=grp_pd)
i_showEQ = input.bool(true, "Show Equilibrium", group=grp_pd)
i_showOTE = input.bool(true, "Show OTE Zone (62-79%)", group=grp_pd)
i_pdLookback = input.int(50, "PD Range Lookback", minval=10, maxval=200, group=grp_pd)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POWER OF THREE SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_po3 = "ğŸ”º POWER OF THREE (AMD)"
i_showPO3 = input.bool(true, "Show Power of Three", group=grp_po3)
i_showPO3Labels = input.bool(true, "Show AMD Phase Labels", group=grp_po3)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2022 MODEL SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_2022 = "ğŸ“š 2022 MODEL"
i_show2022 = input.bool(true, "Show 2022 Model Setups", group=grp_2022)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_sess = "â° SESSIONS & KILLZONES"
i_showSessions = input.bool(true, "Show Session Backgrounds", group=grp_sess)
i_showKillzones = input.bool(true, "Highlight Killzones", group=grp_sess)
i_showSilverBullet = input.bool(true, "Show Silver Bullet Windows", group=grp_sess)
i_showMacro = input.bool(true, "Show Macro Times (:50/:10)", group=grp_sess)
i_showMidnight = input.bool(true, "Show Midnight Open", group=grp_sess)
i_timezone = input.string("America/New_York", "Timezone", options=["America/New_York", "America/Chicago", "Europe/London", "Asia/Tokyo"], group=grp_sess)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPOSITE SCORING SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_comp = "ğŸ† COMPOSITE SCORING"
i_showComposite = input.bool(true, "Show Composite Signals", group=grp_comp)
i_tier1Threshold = input.int(80, "Tier 1 Threshold", minval=50, maxval=100, group=grp_comp)
i_tier2Threshold = input.int(60, "Tier 2 Threshold", minval=30, maxval=80, group=grp_comp)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLORS (Refined Retro-Arcade Palette)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
grp_colors = "ğŸ¨ COLORS"
i_bullColor = input.color(color.new(#00E676, 0), "Bullish Color", group=grp_colors)  // Neon green
i_bearColor = input.color(color.new(#FF1744, 0), "Bearish Color", group=grp_colors)  // Hot pink-red
i_neutralColor = input.color(color.new(#FFD740, 0), "Neutral Color", group=grp_colors)  // Warm yellow
i_obColor = input.color(color.new(#448AFF, 20), "Order Block Color", group=grp_colors)  // Electric blue
i_fvgColor = input.color(color.new(#7C4DFF, 30), "FVG Color", group=grp_colors)  // Purple
i_liqColor = input.color(color.new(#FF9100, 0), "Liquidity Color", group=grp_colors)  // Orange
i_pacmanColor = input.color(color.new(#FFEB3B, 0), "Pac-Man Color", group=grp_colors)  // Classic yellow

// Visual Style Settings
grp_style = "ğŸ¨ VISUAL STYLE"
i_tableStyle = input.string("Minimal", "Dashboard Style", options=["Minimal", "Classic", "Compact"], group=grp_style)
i_boxTransparency = input.int(88, "Zone Box Transparency", minval=70, maxval=95, group=grp_style)
i_labelStyle = input.string("Clean", "Label Style", options=["Clean", "Badge", "Minimal"], group=grp_style)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        CONSTANTS & ENUMS                                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Order Block Lifecycle States
OB_FRESH = 0
OB_PROPULSION = 1
OB_TESTED = 2
OB_MITIGATED = 3
OB_VIOLATED = 4

// Direction
DIR_BULL = 1
DIR_BEAR = -1
DIR_NEUTRAL = 0

// Composite Tiers
TIER_1 = 1
TIER_2 = 2
TIER_3 = 3

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        TYPE DEFINITIONS                                        â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Order Block Type
type OrderBlock
    float top
    float bottom
    int startBar
    int direction  // 1 = bullish, -1 = bearish
    int state      // OB_FRESH, OB_PROPULSION, etc.
    bool isBreaker
    box visual
    label stateLabel

// FVG Type
type FVG
    float top
    float bottom
    int startBar
    int direction
    bool mitigated
    float mitLevel
    box visual

// Liquidity Level Type
type LiqLevel
    float level
    int bar
    int touches
    bool swept
    string liqType  // "EQH", "EQL", "SH", "SL"
    line visual

// Swing Point Type
type SwingPoint
    float price
    int bar
    int direction

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        GLOBAL VARIABLES                                        â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Arrays for Order Blocks
var array<OrderBlock> bullOBs = array.new<OrderBlock>()
var array<OrderBlock> bearOBs = array.new<OrderBlock>()

// Arrays for FVGs
var array<FVG> bullFVGs = array.new<FVG>()
var array<FVG> bearFVGs = array.new<FVG>()

// Arrays for Liquidity
var array<LiqLevel> bslLevels = array.new<LiqLevel>()
var array<LiqLevel> sslLevels = array.new<LiqLevel>()

// Swing Points
var array<SwingPoint> swingHighs = array.new<SwingPoint>()
var array<SwingPoint> swingLows = array.new<SwingPoint>()

// Market Structure
var int msDirection = 0
var float lastSwingHigh = na
var float lastSwingLow = na
var int lastSwingHighBar = 0
var int lastSwingLowBar = 0
var bool bosDetected = false
var bool chochDetected = false

// HTF Bias
var int htfBias = 0
var bool htfBullValid = false
var bool htfBearValid = false

// CBDR
var float cbdrHigh = na
var float cbdrLow = na
var float cbdrRange = na
var bool inCBDR = false

// NWOG
var float nwogHigh = na
var float nwogLow = na
var float nwogCE = na
var bool newWeekStart = false

// Power of Three
var string po3Phase = "ACCUMULATION"
var float accumulationHigh = na
var float accumulationLow = na

// DOL Engine
var float dolTarget = na
var int dolDirection = 0
var float dolProbability = 0.0
var string dolReason = ""

// Turtle Soup with Stalking Stages
var float recentSwingHigh = na
var float recentSwingLow = na
var bool swingHighSwept = false
var bool swingLowSwept = false
var int tsStalking = 0  // 0 = none, 1 = stalking high, -1 = stalking low
var string tsStage = "NONE"  // STALK, TRAP, CONFIRM, INVALID
var int tsStageBar = 0
var float tsEntryPrice = na

// Session tracking
var float asianHigh = na
var float asianLow = na
var float londonHigh = na
var float londonLow = na
var float nyHigh = na
var float nyLow = na
var float midnightOpen = na

// Composite Score
var float compositeScore = 0.0
var int compositeTier = 0
var string patternName = ""

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        HELPER FUNCTIONS                                        â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Check if in session
f_inSession(string sess) =>
    not na(time(timeframe.period, sess, i_timezone))

// Get current NY hour
f_nyHour() =>
    hour(time, i_timezone)

// Get current NY minute
f_nyMinute() =>
    minute(time, i_timezone)

// Calculate tick size
f_tickSize() =>
    syminfo.mintick

// Check if price is in range
f_inRange(float price, float top, float bottom) =>
    price >= bottom and price <= top

// Get mitigation percentage value
f_getMitPct() =>
    i_fvgMitigation == "25%" ? 0.25 : i_fvgMitigation == "50%" ? 0.50 : i_fvgMitigation == "75%" ? 0.75 : 1.0

// Clean old visuals from array
f_cleanOldOBs(array<OrderBlock> obs, int maxAge) =>
    if array.size(obs) > 0
        for i = array.size(obs) - 1 to 0
            ob = array.get(obs, i)
            if bar_index - ob.startBar > maxAge or ob.state == OB_VIOLATED
                if not na(ob.visual)
                    box.delete(ob.visual)
                if not na(ob.stateLabel)
                    label.delete(ob.stateLabel)
                array.remove(obs, i)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        SESSION DETECTION                                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

nyHour = f_nyHour()
nyMinute = f_nyMinute()

// Session definitions (NY Time)
asianSession = nyHour >= 20 or nyHour < 0
londonSession = nyHour >= 2 and nyHour < 5
londonOpen = nyHour >= 3 and nyHour < 4
nyAMSession = nyHour >= 9 and nyHour < 12
nyPMSession = nyHour >= 13 and nyHour < 16
nyAMOpen = nyHour >= 9 and nyHour < 10

// Killzones
asianKZ = nyHour >= 20 or nyHour < 0
londonKZ = nyHour >= 2 and nyHour < 5
nyAMKZ = nyHour >= 9 and nyHour < 11
nyPMKZ = nyHour >= 13 and nyHour < 15

// Silver Bullet Windows
sb1 = nyHour == 3 and nyMinute >= 0 and nyMinute < 15
sb2 = nyHour == 10 and nyMinute >= 0 and nyMinute < 15
sb3 = nyHour == 14 and nyMinute >= 0 and nyMinute < 15
inSilverBullet = sb1 or sb2 or sb3

// Macro Times
isMacroTime = nyMinute >= 50 or nyMinute <= 10

// Midnight detection
isMidnight = nyHour == 0 and nyMinute == 0

// CBDR Session
inCBDRSession = f_inSession(i_cbdrSession)

// Judas Session
inJudasSession = f_inSession(i_judasSession)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        SWING POINT DETECTION                                   â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Detect swing highs and lows using pivot
pivotHigh = ta.pivothigh(high, i_msLookback, i_msLookback)
pivotLow = ta.pivotlow(low, i_msLookback, i_msLookback)

isSwingHigh = not na(pivotHigh)
isSwingLow = not na(pivotLow)

// Update swing tracking
if isSwingHigh
    lastSwingHigh := pivotHigh
    lastSwingHighBar := bar_index - i_msLookback
    swingHighSwept := false
    newSH = SwingPoint.new(pivotHigh, bar_index - i_msLookback, DIR_BULL)
    if array.size(swingHighs) >= 20
        array.shift(swingHighs)
    array.push(swingHighs, newSH)

if isSwingLow
    lastSwingLow := pivotLow
    lastSwingLowBar := bar_index - i_msLookback
    swingLowSwept := false
    newSL = SwingPoint.new(pivotLow, bar_index - i_msLookback, DIR_BEAR)
    if array.size(swingLows) >= 20
        array.shift(swingLows)
    array.push(swingLows, newSL)

// Turtle Soup swing tracking
high20 = ta.highest(high, i_tsLookback)
low20 = ta.lowest(low, i_tsLookback)

recentSwingHigh := high20
recentSwingLow := low20

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        HTF BIAS DETECTION                                      â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Request HTF data
[htfHigh, htfLow, htfClose] = request.security(syminfo.tickerid, i_htfTimeframe, [high, low, close])

// HTF Swing detection (simplified)
htfPivotHigh = ta.pivothigh(htfHigh, i_htfLookback, i_htfLookback)
htfPivotLow = ta.pivotlow(htfLow, i_htfLookback, i_htfLookback)

var float htfLastSwingHigh = na
var float htfLastSwingLow = na

if not na(htfPivotHigh)
    htfLastSwingHigh := htfPivotHigh

if not na(htfPivotLow)
    htfLastSwingLow := htfPivotLow

// Determine HTF Bias
htfBullValid := not na(htfLastSwingLow) and htfClose > htfLastSwingLow
htfBearValid := not na(htfLastSwingHigh) and htfClose < htfLastSwingHigh

if i_htfBias
    htfBias := htfBullValid and not htfBearValid ? DIR_BULL : htfBearValid and not htfBullValid ? DIR_BEAR : htfBias

// Check if current setup aligns with HTF
htfAllowsBull = not i_htfBias or htfBias >= 0
htfAllowsBear = not i_htfBias or htfBias <= 0

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        MARKET STRUCTURE (BOS/CHoCH)                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Bootstrap: Initialize msDirection on first valid swing comparison
// This fixes the "cold start" problem where CHoCH can't detect on chart start
var bool msInitialized = false

if not msInitialized and not na(lastSwingHigh) and not na(lastSwingLow)
    // Initialize based on current price relative to recent swings
    if close > lastSwingHigh
        msDirection := DIR_BULL
        msInitialized := true
    else if close < lastSwingLow
        msDirection := DIR_BEAR
        msInitialized := true
    else
        // Price between swings - use HTF bias if available, else use swing relationship
        if htfBias != 0
            msDirection := htfBias
            msInitialized := true
        else if lastSwingHighBar > lastSwingLowBar
            // More recent high = bullish structure forming
            msDirection := DIR_BULL
            msInitialized := true
        else if lastSwingLowBar > lastSwingHighBar
            // More recent low = bearish structure forming
            msDirection := DIR_BEAR
            msInitialized := true

// Break of Structure (continuation in current direction)
bullishBOS = close > lastSwingHigh and msDirection == DIR_BULL and not na(lastSwingHigh) and msInitialized
bearishBOS = close < lastSwingLow and msDirection == DIR_BEAR and not na(lastSwingLow) and msInitialized

// Change of Character (reversal against current direction)
bullishCHoCH = close > lastSwingHigh and msDirection == DIR_BEAR and not na(lastSwingHigh) and msInitialized
bearishCHoCH = close < lastSwingLow and msDirection == DIR_BULL and not na(lastSwingLow) and msInitialized

// First structure break when not initialized (treat as BOS to establish direction)
firstBullBreak = close > lastSwingHigh and msDirection == DIR_NEUTRAL and not na(lastSwingHigh)
firstBearBreak = close < lastSwingLow and msDirection == DIR_NEUTRAL and not na(lastSwingLow)

// Update market structure
if bullishBOS or bullishCHoCH or firstBullBreak
    msDirection := DIR_BULL
    bosDetected := bullishBOS or firstBullBreak
    chochDetected := bullishCHoCH
    msInitialized := true

if bearishBOS or bearishCHoCH or firstBearBreak
    msDirection := DIR_BEAR
    bosDetected := bearishBOS or firstBearBreak
    chochDetected := bearishCHoCH
    msInitialized := true

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        TURTLE SOUP DETECTION (Enhanced with Stalking)          â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ATR for stalk distance calculation
atrVal = ta.atr(14)

// Turtle Soup: Failed breakout with reversal
tsBuffer = i_tsBuffer * f_tickSize()
stalkDist = atrVal * 0.5  // Distance to start stalking

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STALKING STAGES: ğŸ‘€ STALK â†’ ğŸ¯ TRAP â†’ TS CONFIRM â†’ ğŸš« INVALID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Check if near swing high (stalking)
nearSwingHigh = not na(recentSwingHigh) and not swingHighSwept and high >= recentSwingHigh - stalkDist and high < recentSwingHigh

// Check if near swing low (stalking)
nearSwingLow = not na(recentSwingLow) and not swingLowSwept and low <= recentSwingLow + stalkDist and low > recentSwingLow

// STALK stage - approaching the high/low
if nearSwingHigh and tsStage != "TRAP" and tsStage != "CONFIRM"
    tsStage := "STALK_HIGH"
    tsStalking := 1
    tsStageBar := bar_index

if nearSwingLow and tsStage != "TRAP" and tsStage != "CONFIRM"
    tsStage := "STALK_LOW"
    tsStalking := -1
    tsStageBar := bar_index

// TRAP stage - price sweeps the level
if tsStalking == 1 and high > recentSwingHigh + tsBuffer
    if tsStage == "STALK_HIGH"
        tsStage := "TRAP"
        tsStageBar := bar_index

if tsStalking == -1 and low < recentSwingLow - tsBuffer
    if tsStage == "STALK_LOW"
        tsStage := "TRAP"
        tsStageBar := bar_index

// Bearish Turtle Soup CONFIRM: Sweep high, close back inside
bearishTS = i_showTurtleSoup and htfAllowsBear and not na(recentSwingHigh) and not swingHighSwept and high > recentSwingHigh + tsBuffer and close < recentSwingHigh and close < open

// Bullish Turtle Soup CONFIRM: Sweep low, close back inside
bullishTS = i_showTurtleSoup and htfAllowsBull and not na(recentSwingLow) and not swingLowSwept and low < recentSwingLow - tsBuffer and close > recentSwingLow and close > open

// CONFIRM stage
if bearishTS
    tsStage := "CONFIRM_BEAR"
    tsEntryPrice := close
    tsStalking := 1
    tsStageBar := bar_index

if bullishTS
    tsStage := "CONFIRM_BULL"
    tsEntryPrice := close
    tsStalking := -1
    tsStageBar := bar_index

// INVALID stage - if price continues in sweep direction
if tsStage == "TRAP" and tsStalking == 1
    if close > recentSwingHigh and close > open
        tsStage := "INVALID"
        tsStageBar := bar_index

if tsStage == "TRAP" and tsStalking == -1
    if close < recentSwingLow and close < open
        tsStage := "INVALID"
        tsStageBar := bar_index

// Reset after confirmation is old
if bar_index - tsStageBar > 10 and (tsStage == "CONFIRM_BULL" or tsStage == "CONFIRM_BEAR" or tsStage == "INVALID")
    tsStage := "NONE"
    tsStalking := 0

// Update sweep tracking
if high > recentSwingHigh + tsBuffer
    swingHighSwept := true

if low < recentSwingLow - tsBuffer
    swingLowSwept := true

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        JUDAS SWING DETECTION                                   â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Track Asian range for Judas reference
if asianSession
    if na(asianHigh) or nyHour == 20
        asianHigh := high
        asianLow := low
    else
        asianHigh := math.max(asianHigh, high)
        asianLow := math.min(asianLow, low)

// Judas Swing: False move during London opposite to true NY direction
bearishJudas = i_showJudas and inJudasSession and not na(asianHigh) and high > asianHigh and close < open and htfAllowsBear

bullishJudas = i_showJudas and inJudasSession and not na(asianLow) and low < asianLow and close > open and htfAllowsBull

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        ORDER BLOCK DETECTION                                   â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Displacement detection (atrVal defined earlier in Turtle Soup section)
displacementUp = (close - open) > atrVal * 1.5 and close > open
displacementDown = (open - close) > atrVal * 1.5 and close < open

// Bullish OB: Last down candle before displacement up
bullishOB = close[1] < open[1] and displacementUp and close > high[1]

// Bearish OB: Last up candle before displacement down
bearishOB = close[1] > open[1] and displacementDown and close < low[1]

// ICT-style Order Block colors (blue for bullish, red for bearish)
obBullColor = color.new(#00B4D8, 0)  // ICT blue
obBearColor = color.new(#E63946, 0)  // ICT red

// Create and manage Order Blocks - ICT style with labels
if bullishOB and i_showOB
    newOB = OrderBlock.new(
         high[1], low[1], bar_index - 1, DIR_BULL, OB_FRESH, false,
         box.new(bar_index - 1, high[1], bar_index + 20, low[1],
                 border_color=color.new(obBullColor, 0), bgcolor=color.new(obBullColor, 70),
                 border_width=2, border_style=line.style_solid,
                 text="OB", text_color=color.new(obBullColor, 0), text_size=size.tiny, text_halign=text.align_right),
         i_obShowLifecycle ? label.new(bar_index - 1, high[1], "â—",
                                       style=label.style_none, textcolor=color.new(obBullColor, 30), size=size.tiny) : na)
    if array.size(bullOBs) >= 10
        oldOB = array.shift(bullOBs)
        if not na(oldOB.visual)
            box.delete(oldOB.visual)
        if not na(oldOB.stateLabel)
            label.delete(oldOB.stateLabel)
    array.push(bullOBs, newOB)

if bearishOB and i_showOB
    newOB = OrderBlock.new(
         high[1], low[1], bar_index - 1, DIR_BEAR, OB_FRESH, false,
         box.new(bar_index - 1, high[1], bar_index + 20, low[1],
                 border_color=color.new(obBearColor, 0), bgcolor=color.new(obBearColor, 70),
                 border_width=2, border_style=line.style_solid,
                 text="OB", text_color=color.new(obBearColor, 0), text_size=size.tiny, text_halign=text.align_right),
         i_obShowLifecycle ? label.new(bar_index - 1, high[1], "â—",
                                       style=label.style_none, textcolor=color.new(obBearColor, 30), size=size.tiny) : na)
    if array.size(bearOBs) >= 10
        oldOB = array.shift(bearOBs)
        if not na(oldOB.visual)
            box.delete(oldOB.visual)
        if not na(oldOB.stateLabel)
            label.delete(oldOB.stateLabel)
    array.push(bearOBs, newOB)

// ICT-style Breaker colors (orange tones - violated OBs become support/resistance)
brkBullColor = color.new(#FF9F1C, 0)  // Orange for bullish breaker
brkBearColor = color.new(#F77F00, 0)  // Dark orange for bearish breaker

// Update OB Lifecycle States
f_updateOBState(array<OrderBlock> obs, bool isBull) =>
    if array.size(obs) > 0
        for i = 0 to array.size(obs) - 1
            ob = array.get(obs, i)
            mitPrice = i_obMitigation == "Wick" ? (isBull ? low : high) :
                      i_obMitigation == "Close" ? close :
                      (high + low) / 2

            // State transitions
            if ob.state == OB_FRESH
                // Move to propulsion after price moves away
                if isBull and close > ob.top * 1.001
                    ob.state := OB_PROPULSION
                else if not isBull and close < ob.bottom * 0.999
                    ob.state := OB_PROPULSION

            else if ob.state == OB_PROPULSION
                // Test when price returns
                if isBull and mitPrice <= ob.top and mitPrice >= ob.bottom
                    ob.state := OB_TESTED
                else if not isBull and mitPrice >= ob.bottom and mitPrice <= ob.top
                    ob.state := OB_TESTED

            else if ob.state == OB_TESTED
                // Mitigated if price pushes through 50%
                midPoint = (ob.top + ob.bottom) / 2
                if isBull and mitPrice < midPoint
                    ob.state := OB_MITIGATED
                else if not isBull and mitPrice > midPoint
                    ob.state := OB_MITIGATED

            else if ob.state == OB_MITIGATED
                // Violated if price closes beyond OB - becomes Breaker
                if isBull and close < ob.bottom
                    ob.state := OB_VIOLATED
                    ob.isBreaker := true
                    // Update box to Breaker style
                    if not na(ob.visual)
                        box.set_border_color(ob.visual, color.new(brkBearColor, 20))
                        box.set_bgcolor(ob.visual, color.new(brkBearColor, 85))
                        box.set_text(ob.visual, "BRK")
                        box.set_text_color(ob.visual, color.new(brkBearColor, 10))
                else if not isBull and close > ob.top
                    ob.state := OB_VIOLATED
                    ob.isBreaker := true
                    // Update box to Breaker style
                    if not na(ob.visual)
                        box.set_border_color(ob.visual, color.new(brkBullColor, 20))
                        box.set_bgcolor(ob.visual, color.new(brkBullColor, 85))
                        box.set_text(ob.visual, "BRK")
                        box.set_text_color(ob.visual, color.new(brkBullColor, 10))

            // Update label - Clean minimal indicators
            if not na(ob.stateLabel) and i_obShowLifecycle
                stateText = ob.state == OB_FRESH ? "â—" :
                           ob.state == OB_PROPULSION ? "â—‰" :
                           ob.state == OB_TESTED ? "â—" :
                           ob.state == OB_MITIGATED ? "â—‹" :
                           ob.isBreaker ? "âŠ˜" : "âœ•"
                label.set_text(ob.stateLabel, stateText)
                label.set_x(ob.stateLabel, bar_index)

f_updateOBState(bullOBs, true)
f_updateOBState(bearOBs, false)

// Clean old OBs
f_cleanOldOBs(bullOBs, i_obMaxAge)
f_cleanOldOBs(bearOBs, i_obMaxAge)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        FVG / IFVG DETECTION                                    â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Bullish FVG: Gap up (low > high[2])
bullishFVG = low > high[2] and close[1] > open[1]
bullishFVGTop = low
bullishFVGBottom = high[2]

// Bearish FVG: Gap down (high < low[2])
bearishFVG = high < low[2] and close[1] < open[1]
bearishFVGTop = low[2]
bearishFVGBottom = high

// Check minimum size
minFVGSize = i_fvgMinSize * f_tickSize()

// ICT-style FVG colors (gold/amber for visibility)
fvgBullColor = color.new(#FFB703, 0)  // Gold for bullish FVG
fvgBearColor = color.new(#FB8500, 0)  // Amber for bearish FVG

// Create FVGs - ICT style with labels
if bullishFVG and i_showFVG and (bullishFVGTop - bullishFVGBottom) >= minFVGSize
    mitPct = f_getMitPct()
    mitLevel = bullishFVGBottom + (bullishFVGTop - bullishFVGBottom) * mitPct
    newFVG = FVG.new(
         bullishFVGTop, bullishFVGBottom, bar_index, DIR_BULL, false, mitLevel,
         box.new(bar_index - 2, bullishFVGTop, bar_index + 15, bullishFVGBottom,
                 border_color=color.new(fvgBullColor, 30), bgcolor=color.new(fvgBullColor, 88),
                 border_width=1, border_style=line.style_solid,
                 text="FVG", text_color=color.new(fvgBullColor, 20), text_size=size.tiny, text_halign=text.align_right))
    if array.size(bullFVGs) >= 15
        oldFVG = array.shift(bullFVGs)
        if not na(oldFVG.visual)
            box.delete(oldFVG.visual)
    array.push(bullFVGs, newFVG)

if bearishFVG and i_showFVG and (bearishFVGTop - bearishFVGBottom) >= minFVGSize
    mitPct = f_getMitPct()
    mitLevel = bearishFVGTop - (bearishFVGTop - bearishFVGBottom) * mitPct
    newFVG = FVG.new(
         bearishFVGTop, bearishFVGBottom, bar_index, DIR_BEAR, false, mitLevel,
         box.new(bar_index - 2, bearishFVGTop, bar_index + 15, bearishFVGBottom,
                 border_color=color.new(fvgBearColor, 30), bgcolor=color.new(fvgBearColor, 88),
                 border_width=1, border_style=line.style_solid,
                 text="FVG", text_color=color.new(fvgBearColor, 20), text_size=size.tiny, text_halign=text.align_right))
    if array.size(bearFVGs) >= 15
        oldFVG = array.shift(bearFVGs)
        if not na(oldFVG.visual)
            box.delete(oldFVG.visual)
    array.push(bearFVGs, newFVG)

// Update FVG mitigation
f_updateFVGMitigation(array<FVG> fvgs, bool isBull) =>
    if array.size(fvgs) > 0
        for i = array.size(fvgs) - 1 to 0
            fvg = array.get(fvgs, i)
            if not fvg.mitigated
                if isBull and low <= fvg.mitLevel
                    fvg.mitigated := true
                    if not na(fvg.visual)
                        box.set_bgcolor(fvg.visual, color.new(color.gray, 90))
                else if not isBull and high >= fvg.mitLevel
                    fvg.mitigated := true
                    if not na(fvg.visual)
                        box.set_bgcolor(fvg.visual, color.new(color.gray, 90))

f_updateFVGMitigation(bullFVGs, true)
f_updateFVGMitigation(bearFVGs, false)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        IFVG (Inverse FVG) DETECTION                            â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// IFVG: When price fills a FVG then reverses, the filled FVG becomes inverse zone
// Track recently mitigated FVGs and check for reversal

var array<FVG> bullIFVGs = array.new<FVG>()
var array<FVG> bearIFVGs = array.new<FVG>()

// ICT-style IFVG colors (purple tones - inverted zones)
ifvgBearClr = color.new(#9D4EDD, 0)  // Purple for bearish IFVG
ifvgBullClr = color.new(#7B2CBF, 0)  // Deep purple for bullish IFVG

// Check for IFVG creation from mitigated FVGs
f_checkIFVG(array<FVG> fvgs, array<FVG> ifvgs, bool wasBull) =>
    if array.size(fvgs) > 0
        for i = array.size(fvgs) - 1 to 0
            fvg = array.get(fvgs, i)
            // If FVG was just mitigated and we see reversal candle
            if fvg.mitigated and bar_index - fvg.startBar <= 20
                // Check for reversal after mitigation
                reversalCandle = wasBull ? (close < open and close < fvg.bottom) : (close > open and close > fvg.top)
                if reversalCandle and i_showIFVG
                    // Create IFVG (opposite direction)
                    newDir = wasBull ? DIR_BEAR : DIR_BULL
                    ifvgClr = wasBull ? ifvgBearClr : ifvgBullClr
                    newIFVG = FVG.new(
                         fvg.top, fvg.bottom, bar_index, newDir, false, (fvg.top + fvg.bottom) / 2,
                         box.new(bar_index - 1, fvg.top, bar_index + 10, fvg.bottom,
                                 border_color=color.new(ifvgClr, 20), bgcolor=color.new(ifvgClr, 85),
                                 border_width=2, border_style=line.style_solid,
                                 text="IFVG", text_color=color.new(ifvgClr, 10), text_size=size.tiny, text_halign=text.align_right))
                    if array.size(ifvgs) >= 5
                        oldIFVG = array.shift(ifvgs)
                        if not na(oldIFVG.visual)
                            box.delete(oldIFVG.visual)
                    array.push(ifvgs, newIFVG)
                    // Mark original as processed by moving far back
                    fvg.startBar := bar_index - 1000

f_checkIFVG(bullFVGs, bearIFVGs, true)
f_checkIFVG(bearFVGs, bullIFVGs, false)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        REJECTION BLOCK DETECTION                               â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Rejection Block: Long wick into a zone that rejects and closes outside
// Bullish RB: Long lower wick, closes in upper half (buying rejection at lows)
// Bearish RB: Long upper wick, closes in lower half (selling rejection at highs)

// Rejection Block Type
type RejBlock
    float top
    float bottom
    int startBar
    int direction
    box visual

var array<RejBlock> rejBlocks = array.new<RejBlock>()

// Calculate candle metrics
bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
totalRange = high - low

// Rejection criteria: wick > 60% of range, body < 40% of range
wickThreshold = 0.6
bodyThreshold = 0.4

// NOTE: Rejection Block detection moved after Premium/Discount zone calculation

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        LIQUIDITY DETECTION                                     â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Equal Highs Detection
f_detectEqualHighs() =>
    found = false
    level = 0.0
    threshold = high * (i_eqThreshold / 100)
    for i = 5 to math.min(i_liqLookback, bar_index - 1)
        if math.abs(high - high[i]) <= threshold
            found := true
            level := math.max(high, high[i])
            break
    [found, level]

// Equal Lows Detection
f_detectEqualLows() =>
    found = false
    level = 0.0
    threshold = low * (i_eqThreshold / 100)
    for i = 5 to math.min(i_liqLookback, bar_index - 1)
        if math.abs(low - low[i]) <= threshold
            found := true
            level := math.min(low, low[i])
            break
    [found, level]

[hasEQH, eqhLevel] = f_detectEqualHighs()
[hasEQL, eqlLevel] = f_detectEqualLows()

// Track BSL/SSL
if hasEQH and i_showEQH
    newLiq = LiqLevel.new(eqhLevel, bar_index, 1, false, "EQH", na)
    if array.size(bslLevels) >= 10
        oldLiq = array.shift(bslLevels)
        if not na(oldLiq.visual)
            line.delete(oldLiq.visual)
    array.push(bslLevels, newLiq)

if hasEQL and i_showEQL
    newLiq = LiqLevel.new(eqlLevel, bar_index, 1, false, "EQL", na)
    if array.size(sslLevels) >= 10
        oldLiq = array.shift(sslLevels)
        if not na(oldLiq.visual)
            line.delete(oldLiq.visual)
    array.push(sslLevels, newLiq)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        IPDA DATA RANGES                                        â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// IPDA lookbacks
high20IPDA = ta.highest(high, 20)
low20IPDA = ta.lowest(low, 20)
high40IPDA = ta.highest(high, 40)
low40IPDA = ta.lowest(low, 40)
high60IPDA = ta.highest(high, 60)
low60IPDA = ta.lowest(low, 60)

// Previous Week High/Low (approximation)
barsPerWeek = 5 * 24 * (60 / timeframe.multiplier)
weeklyBars = math.min(barsPerWeek, 500)
pwHigh = ta.highest(high, int(weeklyBars))
pwLow = ta.lowest(low, int(weeklyBars))

// Previous Month High/Low
barsPerMonth = weeklyBars * 4
monthlyBars = math.min(barsPerMonth, 2000)
pmHigh = ta.highest(high, int(math.min(monthlyBars, bar_index)))
pmLow = ta.lowest(low, int(math.min(monthlyBars, bar_index)))

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        WEEKLY & QUARTERLY PROFILES                             â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Weekly Profile Detection
// ICT teaches specific weekly patterns based on day of week
currentDOW = dayofweek
isMonday = currentDOW == dayofweek.monday
isTuesday = currentDOW == dayofweek.tuesday
isWednesday = currentDOW == dayofweek.wednesday
isThursday = currentDOW == dayofweek.thursday
isFriday = currentDOW == dayofweek.friday

// Weekly Profile Types based on ICT teachings:
// - Classic: Mon/Tue consolidation, Wed reversal, Thu/Fri expansion
// - Seek & Destroy: Wed/Thu reversals trap traders
var string weeklyProfile = "DEVELOPING"
var float weekHigh = na
var float weekLow = na
var float mondayHigh = na
var float mondayLow = na

// Track weekly range
if isMonday and (not isMonday[1] or na(weekHigh))
    weekHigh := high
    weekLow := low
    mondayHigh := high
    mondayLow := low
    weeklyProfile := "ACCUMULATION"
else if not isMonday and isMonday[1]
    mondayHigh := high[1]
    mondayLow := low[1]

if not na(weekHigh)
    weekHigh := math.max(weekHigh, high)
    weekLow := math.min(weekLow, low)

// Detect weekly profile pattern
if isTuesday
    weeklyProfile := "ACCUMULATION"
else if isWednesday
    // Wednesday is often manipulation/reversal day
    weeklyProfile := "MANIPULATION"
else if isThursday
    weeklyProfile := "DISTRIBUTION"
else if isFriday
    weeklyProfile := "DISTRIBUTION"

// Quarterly Shift Detection
// Q1: Jan-Mar, Q2: Apr-Jun, Q3: Jul-Sep, Q4: Oct-Dec
currentMonth = month
isQ1 = currentMonth >= 1 and currentMonth <= 3
isQ2 = currentMonth >= 4 and currentMonth <= 6
isQ3 = currentMonth >= 7 and currentMonth <= 9
isQ4 = currentMonth >= 10 and currentMonth <= 12

// Quarterly shift months (first month of quarter often sees direction change)
isQuarterStart = currentMonth == 1 or currentMonth == 4 or currentMonth == 7 or currentMonth == 10
quarterName = isQ1 ? "Q1" : isQ2 ? "Q2" : isQ3 ? "Q3" : "Q4"

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        OPENING RANGE GAP (ORG)                                 â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Opening Range Gap: Gap between previous session close and current session open
// This is a key ICT concept for gap trading

var float prevDayClose = na
var float currentDayOpen = na
var float orgHigh = na
var float orgLow = na
var float orgCE = na
var bool hasORG = false

// Detect new day (for intraday timeframes)
isNewDay = ta.change(time("D")) != 0

if isNewDay
    prevDayClose := close[1]
    currentDayOpen := open
    // ORG exists if there's a gap
    if not na(prevDayClose) and math.abs(currentDayOpen - prevDayClose) > atrVal * 0.25
        orgHigh := math.max(prevDayClose, currentDayOpen)
        orgLow := math.min(prevDayClose, currentDayOpen)
        orgCE := (orgHigh + orgLow) / 2
        hasORG := true
    else
        hasORG := false

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        SEEK & DESTROY DETECTION                                â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Seek & Destroy: ICT concept where Wed/Thu are reversal days that trap traders
// Market sweeps one side of Monday's range then reverses

// S&D Profile Detection
var bool seekDestroyDay = false
var string sdPhase = "NONE"  // SEEK, DESTROY, COMPLETE

// Wed/Thu are primary S&D days
seekDestroyDay := isWednesday or isThursday

// Detect S&D pattern
sdSeekingHigh = seekDestroyDay and not na(mondayHigh) and high > mondayHigh
sdSeekingLow = seekDestroyDay and not na(mondayLow) and low < mondayLow

// Phase detection
if seekDestroyDay
    if sdSeekingHigh and close < mondayHigh and close < open
        sdPhase := "DESTROY_BEARS"  // Swept high, reversing down
    else if sdSeekingLow and close > mondayLow and close > open
        sdPhase := "DESTROY_BULLS"  // Swept low, reversing up
    else if sdSeekingHigh or sdSeekingLow
        sdPhase := "SEEK"  // Currently seeking liquidity
    else
        sdPhase := "WATCH"  // S&D day but no sweep yet
else
    sdPhase := "NONE"

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        CBDR (Central Bank Dealers Range)                       â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Track CBDR session
if inCBDRSession and i_showCBDR
    if not inCBDR[1] or na(cbdrHigh)
        cbdrHigh := high
        cbdrLow := low
        inCBDR := true
    else
        cbdrHigh := math.max(cbdrHigh, high)
        cbdrLow := math.min(cbdrLow, low)
else if inCBDR[1] and not inCBDRSession
    cbdrRange := cbdrHigh - cbdrLow
    inCBDR := false

// CBDR SD Projections
cbdrSD1High = not na(cbdrHigh) ? cbdrHigh + cbdrRange * i_cbdrSD : na
cbdrSD1Low = not na(cbdrLow) ? cbdrLow - cbdrRange * i_cbdrSD : na

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        NWOG (New Week Opening Gap)                             â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Detect new week
isNewWeek = dayofweek == dayofweek.monday and dayofweek[1] != dayofweek.monday

if isNewWeek and i_showNWOG
    // NWOG = Gap between Friday close and Sunday/Monday open
    nwogHigh := math.max(close[1], open)
    nwogLow := math.min(close[1], open)
    nwogCE := (nwogHigh + nwogLow) / 2
    newWeekStart := true

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        PREMIUM / DISCOUNT ZONES                                â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Calculate range
rangeHigh = ta.highest(high, i_pdLookback)
rangeLow = ta.lowest(low, i_pdLookback)
rangeSize = rangeHigh - rangeLow
equilibrium = rangeLow + rangeSize * 0.5

// Zones
premiumZone = rangeLow + rangeSize * 0.7
discountZone = rangeLow + rangeSize * 0.3

inPremium = close > premiumZone
inDiscount = close < discountZone
atEquilibrium = close >= discountZone and close <= premiumZone

// OTE Zone (62-79%)
oteTop = msDirection == DIR_BULL ? rangeLow + rangeSize * 0.79 : rangeHigh - rangeSize * 0.62
oteBottom = msDirection == DIR_BULL ? rangeLow + rangeSize * 0.62 : rangeHigh - rangeSize * 0.79
inOTE = f_inRange(close, math.max(oteTop, oteBottom), math.min(oteTop, oteBottom))

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REJECTION BLOCK DETECTION (uses inPremium/inDiscount defined above)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Bullish Rejection Block: Long lower wick at discount
bullishRejection = i_showRejBlock and totalRange > 0 and lowerWick / totalRange >= wickThreshold and bodySize / totalRange <= bodyThreshold and close > open and inDiscount

// Bearish Rejection Block: Long upper wick at premium
bearishRejection = i_showRejBlock and totalRange > 0 and upperWick / totalRange >= wickThreshold and bodySize / totalRange <= bodyThreshold and close < open and inPremium

// ICT-style Rejection Block colors (teal/coral)
rbBullColor = color.new(#2EC4B6, 0)  // Teal for bullish rejection
rbBearColor = color.new(#E71D36, 0)  // Coral red for bearish rejection
rbDotsColor = color.new(#FFEB3B, 0)  // Pac-Man yellow for strength dots

// RB Strength scoring function
f_rbStrength(float wickPct, float bodyPct, bool inKZ) =>
    score = 1  // Base score
    if wickPct >= 0.70
        score += 1  // Extra long wick
    if inKZ or bodyPct <= 0.30
        score += 1  // In killzone or extra small body
    score

// Create Rejection Blocks - ICT style with strength dots
if bullishRejection
    wickPct = lowerWick / totalRange
    bodyPct = bodySize / totalRange
    kzActive = londonKZ or nyAMKZ or nyPMKZ or inSilverBullet
    rbScore = f_rbStrength(wickPct, bodyPct, kzActive)
    rbDots = rbScore >= 3 ? "â—â—â—" : rbScore >= 2 ? "â—â—â—‹" : "â—â—‹â—‹"
    newRB = RejBlock.new(
         math.max(close, open), low, bar_index, DIR_BULL,
         box.new(bar_index, math.max(close, open), bar_index + 15, low,
                 border_color=color.new(rbBullColor, 20), bgcolor=color.new(rbBullColor, 85),
                 border_width=2, border_style=line.style_solid,
                 text="RB " + rbDots, text_color=rbDotsColor, text_size=size.tiny, text_halign=text.align_right))
    if array.size(rejBlocks) >= 8
        oldRB = array.shift(rejBlocks)
        if not na(oldRB.visual)
            box.delete(oldRB.visual)
    array.push(rejBlocks, newRB)

if bearishRejection
    wickPct = upperWick / totalRange
    bodyPct = bodySize / totalRange
    kzActive = londonKZ or nyAMKZ or nyPMKZ or inSilverBullet
    rbScore = f_rbStrength(wickPct, bodyPct, kzActive)
    rbDots = rbScore >= 3 ? "â—â—â—" : rbScore >= 2 ? "â—â—â—‹" : "â—â—‹â—‹"
    newRB = RejBlock.new(
         high, math.min(close, open), bar_index, DIR_BEAR,
         box.new(bar_index, high, bar_index + 15, math.min(close, open),
                 border_color=color.new(rbBearColor, 20), bgcolor=color.new(rbBearColor, 85),
                 border_width=2, border_style=line.style_solid,
                 text="RB " + rbDots, text_color=rbDotsColor, text_size=size.tiny, text_halign=text.align_right))
    if array.size(rejBlocks) >= 8
        oldRB = array.shift(rejBlocks)
        if not na(oldRB.visual)
            box.delete(oldRB.visual)
    array.push(rejBlocks, newRB)

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        POWER OF THREE (AMD)                                    â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Asian = Accumulation, London = Manipulation, NY = Distribution
if asianSession
    po3Phase := "ACCUMULATION"
    if nyHour == 20 or na(accumulationHigh)
        accumulationHigh := high
        accumulationLow := low
    else
        accumulationHigh := math.max(accumulationHigh, high)
        accumulationLow := math.min(accumulationLow, low)
else if londonSession
    po3Phase := "MANIPULATION"
else if nyAMSession or nyPMSession
    po3Phase := "DISTRIBUTION"

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        2022 MODEL DETECTION                                    â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// 2022 Model: Sweep + Displacement + FVG
sweepLows = low < low20IPDA[1] and close > open
sweepHighs = high > high20IPDA[1] and close < open

model2022Bull = i_show2022 and sweepLows[1] and displacementUp and bullishFVG
model2022Bear = i_show2022 and sweepHighs[1] and displacementDown and bearishFVG

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        MIDNIGHT OPEN TRACKING                                  â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if isMidnight
    midnightOpen := open

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                     ğŸ® PAC-MAN DOL ENGINE (THE MAZE)                           â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Initialize scoring (Cortex-derived weights based on ICT concept frequency)
bullScore = 0.0
bearScore = 0.0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORTEX ICT CONCEPT WEIGHTS (Based on transcript analysis)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// 1. MARKET STRUCTURE (Weight: 20) - 8,016 mentions
if msDirection == DIR_BULL
    bullScore += 20
else if msDirection == DIR_BEAR
    bearScore += 20

// CHoCH bonus (significant reversal signal)
if bullishCHoCH
    bullScore += 15
if bearishCHoCH
    bearScore += 15

// BOS confirmation
if bullishBOS
    bullScore += 8
if bearishBOS
    bearScore += 8

// 2. HTF BIAS ALIGNMENT (Weight: 18) - Critical for confluence
if htfBias == DIR_BULL and msDirection == DIR_BULL
    bullScore += 18
else if htfBias == DIR_BEAR and msDirection == DIR_BEAR
    bearScore += 18

// 3. LIQUIDITY (Weight: 15) - 7,892 mentions
// Check proximity to liquidity pools
nearestBSL = array.size(bslLevels) > 0 ? array.get(bslLevels, array.size(bslLevels) - 1).level : na
nearestSSL = array.size(sslLevels) > 0 ? array.get(sslLevels, array.size(sslLevels) - 1).level : na

distToBSL = not na(nearestBSL) ? math.abs(close - nearestBSL) : 9999
distToSSL = not na(nearestSSL) ? math.abs(close - nearestSSL) : 9999

// Price seeks liquidity
if distToBSL < distToSSL * 0.5 and msDirection == DIR_BULL
    bullScore += 15
if distToSSL < distToBSL * 0.5 and msDirection == DIR_BEAR
    bearScore += 15

// 4. PREMIUM/DISCOUNT (Weight: 15) - 6,234 mentions
if inDiscount and msDirection == DIR_BULL
    bullScore += 15
if inPremium and msDirection == DIR_BEAR
    bearScore += 15

// Penalty for wrong zone
if inPremium and msDirection == DIR_BULL
    bullScore -= 5
if inDiscount and msDirection == DIR_BEAR
    bearScore -= 5

// 5. ORDER BLOCKS (Weight: 12) - 5,891 mentions
// Check if price is at a valid OB
atBullOB = false
atBearOB = false

if array.size(bullOBs) > 0
    for i = 0 to math.min(array.size(bullOBs) - 1, 5)
        ob = array.get(bullOBs, i)
        if ob.state == OB_TESTED and f_inRange(close, ob.top, ob.bottom)
            atBullOB := true
            break

if array.size(bearOBs) > 0
    for i = 0 to math.min(array.size(bearOBs) - 1, 5)
        ob = array.get(bearOBs, i)
        if ob.state == OB_TESTED and f_inRange(close, ob.top, ob.bottom)
            atBearOB := true
            break

if atBullOB
    bullScore += 12
if atBearOB
    bearScore += 12

// 6. FVG (Weight: 10) - 4,567 mentions
// Check for unfilled FVGs as targets
bullFVGAbove = false
bearFVGBelow = false

if array.size(bullFVGs) > 0
    for i = 0 to math.min(array.size(bullFVGs) - 1, 5)
        fvg = array.get(bullFVGs, i)
        if not fvg.mitigated and fvg.bottom > close
            bullFVGAbove := true
            break

if array.size(bearFVGs) > 0
    for i = 0 to math.min(array.size(bearFVGs) - 1, 5)
        fvg = array.get(bearFVGs, i)
        if not fvg.mitigated and fvg.top < close
            bearFVGBelow := true
            break

if bullFVGAbove
    bullScore += 10
if bearFVGBelow
    bearScore += 10

// 7. OTE ZONE (Weight: 15) - 4,123 mentions
if inOTE and msDirection == DIR_BULL
    bullScore += 15
if inOTE and msDirection == DIR_BEAR
    bearScore += 15

// 8. KILLZONE TIMING (Weight: 10) - 3,892 mentions
if nyAMKZ or nyPMKZ
    if msDirection == DIR_BULL
        bullScore += 10
    else if msDirection == DIR_BEAR
        bearScore += 10

// 9. SILVER BULLET (Weight: 12) - 3,456 mentions
if inSilverBullet
    if msDirection == DIR_BULL
        bullScore += 12
    else if msDirection == DIR_BEAR
        bearScore += 12

// 10. POWER OF THREE (Weight: 8) - 3,234 mentions
if po3Phase == "DISTRIBUTION"
    if msDirection == DIR_BULL
        bullScore += 8
    else if msDirection == DIR_BEAR
        bearScore += 8

// 11. 2022 MODEL (Weight: 18) - 2,891 mentions (high conviction)
if model2022Bull
    bullScore += 18
if model2022Bear
    bearScore += 18

// 12. TURTLE SOUP (Weight: 15) - 2,567 mentions
if bullishTS
    bullScore += 15
if bearishTS
    bearScore += 15

// 13. JUDAS SWING (Weight: 12) - 2,345 mentions
if bullishJudas
    bullScore += 12
if bearishJudas
    bearScore += 12

// 14. DISPLACEMENT (Weight: 10) - 2,123 mentions
if displacementUp
    bullScore += 10
if displacementDown
    bearScore += 10

// 15. IPDA HISTORICAL LEVELS (Weight: 8) - 1,892 mentions
distToIPDAHigh = math.abs(close - high60IPDA)
distToIPDALow = math.abs(close - low60IPDA)

if distToIPDAHigh < distToIPDALow * 0.3 and msDirection == DIR_BULL
    bullScore += 8
if distToIPDALow < distToIPDAHigh * 0.3 and msDirection == DIR_BEAR
    bearScore += 8

// 16. MIDNIGHT OPEN (Weight: 5) - 1,678 mentions
if not na(midnightOpen)
    if close > midnightOpen and msDirection == DIR_BULL
        bullScore += 5
    else if close < midnightOpen and msDirection == DIR_BEAR
        bearScore += 5

// 17. CBDR SD (Weight: 8) - CBDR as institutional framework
if not na(cbdrSD1High) and not na(cbdrSD1Low)
    if close > cbdrHigh and close < cbdrSD1High
        bullScore += 8
    else if close < cbdrLow and close > cbdrSD1Low
        bearScore += 8

// 18. NWOG (Weight: 6) - New Week Opening Gap
if not na(nwogCE)
    if close > nwogCE and msDirection == DIR_BULL
        bullScore += 6
    else if close < nwogCE and msDirection == DIR_BEAR
        bearScore += 6

// 19. MACRO TIME (Weight: 3) - Increased volatility
if isMacroTime
    bullScore += 3
    bearScore += 3

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATE FINAL DOL DIRECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

totalScore = bullScore + bearScore
dolProbability := totalScore > 0 ? math.max(bullScore, bearScore) / totalScore * 100 : 50

if bullScore > bearScore
    dolDirection := DIR_BULL
    dolTarget := not na(nearestBSL) ? nearestBSL : high20IPDA
else if bearScore > bullScore
    dolDirection := DIR_BEAR
    dolTarget := not na(nearestSSL) ? nearestSSL : low20IPDA
else
    dolDirection := DIR_NEUTRAL
    dolTarget := equilibrium

// Build reason string
dolReason := dolDirection == DIR_BULL ?
             "MS+" + (htfBias == DIR_BULL ? " HTF+" : "") +
             (inDiscount ? " Disc+" : "") + (inOTE ? " OTE+" : "") +
             (bullishTS ? " TS+" : "") + (model2022Bull ? " 2022+" : "") :
             dolDirection == DIR_BEAR ?
             "MS-" + (htfBias == DIR_BEAR ? " HTF-" : "") +
             (inPremium ? " Prem-" : "") + (inOTE ? " OTE-" : "") +
             (bearishTS ? " TS-" : "") + (model2022Bear ? " 2022-" : "") :
             "Neutral"

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        COMPOSITE PATTERN SCORING                               â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Tier calculation based on confluence
compositeScore := dolProbability

// Count active confluence factors for pattern naming
confluenceCount = 0
hasHTFAlignment = htfBias == DIR_BULL and msDirection == DIR_BULL or htfBias == DIR_BEAR and msDirection == DIR_BEAR
hasZoneAlignment = (inDiscount and msDirection == DIR_BULL) or (inPremium and msDirection == DIR_BEAR)
hasOTEEntry = inOTE
hasModel2022 = model2022Bull or model2022Bear
hasTurtleSoup = bullishTS or bearishTS
hasJudas = bullishJudas or bearishJudas
hasDisplacement = displacementUp or displacementDown
hasSilverBullet = inSilverBullet
hasFreshOB = atBullOB or atBearOB

if hasHTFAlignment
    confluenceCount += 1
if hasZoneAlignment
    confluenceCount += 1
if hasOTEEntry
    confluenceCount += 1
if hasModel2022
    confluenceCount += 1
if hasTurtleSoup
    confluenceCount += 1
if hasJudas
    confluenceCount += 1
if hasDisplacement
    confluenceCount += 1
if hasSilverBullet
    confluenceCount += 1
if hasFreshOB
    confluenceCount += 1

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATTERN NAMES (Based on confluence combination)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
patternName := ""

// TIER 1 PATTERNS (12+ points / 80%+ probability)
if compositeScore >= i_tier1Threshold
    if hasModel2022 and hasOTEEntry and hasHTFAlignment
        patternName := "ğŸ† THE APEX"  // Perfect 2022 model setup
    else if hasTurtleSoup and hasOTEEntry and hasZoneAlignment
        patternName := "ğŸ† SWEET SPOT"  // TS + OTE + Zone
    else if hasJudas and hasHTFAlignment and hasSilverBullet
        patternName := "ğŸ† JUDAS TRAP"  // London false move in SB window
    else if hasDisplacement and hasFreshOB and hasZoneAlignment
        patternName := "ğŸ† EXECUTION"  // Clean displacement entry
    else if confluenceCount >= 6
        patternName := "ğŸ† MEGA SETUP"  // 6+ confluences
    else
        patternName := "ğŸ† TIER 1"

// TIER 2 PATTERNS (8-11 points / 60-79% probability)
else if compositeScore >= i_tier2Threshold
    if hasOTEEntry and hasZoneAlignment
        patternName := "ğŸ¥ˆ OTE ZONE"  // OTE + P/D alignment
    else if hasTurtleSoup and hasHTFAlignment
        patternName := "ğŸ¥ˆ SOUP ALIGNED"  // TS with HTF
    else if hasDisplacement and hasFreshOB
        patternName := "ğŸ¥ˆ OB PLAY"  // Displacement to OB
    else if hasSilverBullet and hasZoneAlignment
        patternName := "ğŸ¥ˆ BULLET TIME"  // SB in correct zone
    else if hasJudas
        patternName := "ğŸ¥ˆ JUDAS MOVE"  // Judas swing detected
    else if confluenceCount >= 4
        patternName := "ğŸ¥ˆ FOUNDATION"  // Solid base setup
    else
        patternName := "ğŸ¥ˆ TIER 2"

// TIER 3 PATTERNS (5-7 points / 40-59% probability)
else
    if hasZoneAlignment
        patternName := "ğŸ¥‰ ZONE PLAY"
    else if hasDisplacement
        patternName := "ğŸ¥‰ MOMENTUM"
    else if hasFreshOB
        patternName := "ğŸ¥‰ OB WATCH"
    else
        patternName := "ğŸ¥‰ DEVELOPING"

if i_showComposite
    if compositeScore >= i_tier1Threshold
        compositeTier := TIER_1
    else if compositeScore >= i_tier2Threshold
        compositeTier := TIER_2
    else
        compositeTier := TIER_3

// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
// â•‘                        ğŸ¨ VISUAL RENDERING                                     â•‘
// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION BACKGROUNDS - Very subtle, non-distracting
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

sessionColor = asianSession ? color.new(#9C27B0, 97) :
               londonSession ? color.new(#2196F3, 97) :
               nyAMSession ? color.new(#4CAF50, 97) :
               nyPMSession ? color.new(#FF9800, 97) : na

bgcolor(i_showSessions ? sessionColor : na, title="Session Background")

// Killzone highlight - subtle accent
kzColor = (asianKZ or londonKZ or nyAMKZ or nyPMKZ) and i_showKillzones ? color.new(#FFC107, 95) : na
bgcolor(kzColor, title="Killzone Highlight")

// Silver Bullet highlight - slightly more visible for key windows
bgcolor(i_showSilverBullet and inSilverBullet ? color.new(#00E5FF, 93) : na, title="Silver Bullet")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKET STRUCTURE LABELS (Clean minimal style)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// BOS - subtle small markers
plotshape(i_showBOS and bullishBOS, title="BOS Bull", style=shape.triangleup,
     location=location.abovebar, color=color.new(i_bullColor, 30), text="", size=size.tiny)
plotshape(i_showBOS and bearishBOS, title="BOS Bear", style=shape.triangledown,
     location=location.belowbar, color=color.new(i_bearColor, 30), text="", size=size.tiny)

// CHoCH - more prominent as it's a reversal signal
plotshape(i_showCHoCH and bullishCHoCH, title="CHoCH Bull", style=shape.diamond,
     location=location.abovebar, color=i_neutralColor, text="âŸ²", textcolor=i_neutralColor, size=size.tiny)
plotshape(i_showCHoCH and bearishCHoCH, title="CHoCH Bear", style=shape.diamond,
     location=location.belowbar, color=i_neutralColor, text="âŸ²", textcolor=i_neutralColor, size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TURTLE SOUP LABELS (Clean style)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Turtle Soup - clean minimal badge
plotshape(i_showTurtleSoup and bullishTS, title="Turtle Soup Bull", style=shape.labelup,
     location=location.belowbar, color=color.new(i_bullColor, 20), text="TS", textcolor=color.white, size=size.small)
plotshape(i_showTurtleSoup and bearishTS, title="Turtle Soup Bear", style=shape.labeldown,
     location=location.abovebar, color=color.new(i_bearColor, 20), text="TS", textcolor=color.white, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// JUDAS SWING LABELS (Subtle accent)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plotshape(i_showJudas and bullishJudas, title="Judas Bull", style=shape.circle,
     location=location.belowbar, color=color.new(#9C27B0, 20), text="J", textcolor=color.white, size=size.tiny)
plotshape(i_showJudas and bearishJudas, title="Judas Bear", style=shape.circle,
     location=location.abovebar, color=color.new(#9C27B0, 20), text="J", textcolor=color.white, size=size.tiny)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 2022 MODEL LABELS (Important signal - keep visible)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plotshape(model2022Bull, title="2022 Model Bull", style=shape.labelup,
     location=location.belowbar, color=color.new(#00BCD4, 10), text="2022", textcolor=color.white, size=size.small)
plotshape(model2022Bear, title="2022 Model Bear", style=shape.labeldown,
     location=location.abovebar, color=color.new(#00BCD4, 10), text="2022", textcolor=color.white, size=size.small)

// Swing points and EQH/EQL removed to reduce plot count - tracked via info table

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OTE SPAWN ZONE - Clean gradient style
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var box oteBox = na

if i_showOTE and barstate.islast
    if not na(oteBox)
        box.delete(oteBox)

    // Subtle cyan/teal for OTE zone - distinct but not overwhelming
    oteColor = color.new(#00BCD4, 92)
    oteBorder = color.new(#00BCD4, 70)
    oteBox := box.new(bar_index - 30, math.max(oteTop, oteBottom), bar_index + 10, math.min(oteTop, oteBottom),
         border_color=oteBorder, bgcolor=oteColor, border_width=1, border_style=line.style_dashed,
         text="OTE", text_color=color.new(#00BCD4, 50), text_size=size.tiny, text_halign=text.align_right)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREMIUM/DISCOUNT ZONES - Subtle reference lines
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plot(i_showPDZones ? premiumZone : na, "Premium Zone", color=color.new(i_bearColor, 80), linewidth=1, style=plot.style_linebr)
plot(i_showPDZones ? discountZone : na, "Discount Zone", color=color.new(i_bullColor, 80), linewidth=1, style=plot.style_linebr)
plot(i_showEQ ? equilibrium : na, "Equilibrium", color=color.new(#78909C, 60), linewidth=1, style=plot.style_linebr)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CBDR PROJECTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plot(i_showCBDRProjections and not na(cbdrSD1High) ? cbdrSD1High : na, "CBDR SD+ High", color=color.new(color.teal, 50), linewidth=1, style=plot.style_linebr)
plot(i_showCBDRProjections and not na(cbdrSD1Low) ? cbdrSD1Low : na, "CBDR SD- Low", color=color.new(color.teal, 50), linewidth=1, style=plot.style_linebr)
plot(i_showCBDR and not na(cbdrHigh) ? cbdrHigh : na, "CBDR High", color=color.new(color.teal, 30), linewidth=2, style=plot.style_linebr)
plot(i_showCBDR and not na(cbdrLow) ? cbdrLow : na, "CBDR Low", color=color.new(color.teal, 30), linewidth=2, style=plot.style_linebr)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NWOG ZONE - Clean subtle style
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var box nwogBox = na

if i_showNWOG and not na(nwogHigh) and not na(nwogLow) and barstate.islast
    if not na(nwogBox)
        box.delete(nwogBox)
    nwogBox := box.new(bar_index - 50, nwogHigh, bar_index + 10, nwogLow,
         border_color=color.new(#E040FB, 60), bgcolor=color.new(#E040FB, 93),
         border_width=1, border_style=line.style_dotted,
         text="NWOG", text_color=color.new(#E040FB, 50), text_size=size.tiny, text_halign=text.align_right)

// NWOG CE line
plot(i_showNWOGCE and not na(nwogCE) ? nwogCE : na, "NWOG CE", color=color.new(color.fuchsia, 30), linewidth=2, style=plot.style_linebr)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OPENING RANGE GAP (ORG) VISUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var box orgBox = na

if hasORG and not na(orgHigh) and not na(orgLow) and barstate.islast
    if not na(orgBox)
        box.delete(orgBox)
    orgBox := box.new(bar_index - 20, orgHigh, bar_index + 5, orgLow,
         border_color=color.new(#FF9800, 50), bgcolor=color.new(#FF9800, 92),
         border_width=1, border_style=line.style_dotted,
         text="ORG", text_color=color.new(#FF9800, 40), text_size=size.tiny, text_halign=text.align_right)

// ORG CE line
plot(hasORG and not na(orgCE) ? orgCE : na, "ORG CE", color=color.new(#FF9800, 50), linewidth=1, style=plot.style_linebr)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MIDNIGHT OPEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

plot(i_showMidnight and not na(midnightOpen) ? midnightOpen : na, "Midnight Open", color=color.new(color.white, 50), linewidth=1, style=plot.style_linebr)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IPDA LEVELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// IPDA plots reduced to stay under 64 plot limit
plot(i_ipda60 and i_showIPDA ? high60IPDA : na, "IPDA 60 High", color=color.new(color.blue, 60), linewidth=1, style=plot.style_linebr)
plot(i_ipda60 and i_showIPDA ? low60IPDA : na, "IPDA 60 Low", color=color.new(color.blue, 60), linewidth=1, style=plot.style_linebr)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAC-MAN DOL PATH VISUALIZATION - Sleek arcade style
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var label pacmanLabel = na
var line dolLine = na
var label dolTargetLabel = na
var line dolPathDots = na

if i_showDOL and i_showPacMan and barstate.islast
    // Clean up old visuals
    if not na(pacmanLabel)
        label.delete(pacmanLabel)
    if not na(dolLine)
        line.delete(dolLine)
    if not na(dolTargetLabel)
        label.delete(dolTargetLabel)

    // Draw Pac-Man at current price - cleaner circle icon
    pacChar = dolDirection == DIR_BULL ? "â—" : dolDirection == DIR_BEAR ? "â—‘" : "â—"
    pacmanLabel := label.new(bar_index + 2, close, pacChar,
         style=label.style_none, textcolor=i_pacmanColor, size=size.large)

    // Draw DOL path line - elegant arrow
    arrowColor = dolDirection == DIR_BULL ? color.new(i_bullColor, 20) :
                 dolDirection == DIR_BEAR ? color.new(i_bearColor, 20) : color.new(i_neutralColor, 40)

    if not na(dolTarget)
        dolLine := line.new(bar_index + 2, close, bar_index + 12, dolTarget,
             color=arrowColor, width=2, style=line.style_arrow_right)

        // Target label - minimal clean style
        targetText = dolDirection == DIR_BULL ? "â–² BSL" :
                     dolDirection == DIR_BEAR ? "â–¼ SSL" : "â—† EQ"
        dolTargetLabel := label.new(bar_index + 13, dolTarget, targetText,
             style=label.style_none, textcolor=arrowColor, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIQUIDITY TARGETS (Institutional Levels) - Clean minimal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

var label ghostHighLabel = na
var label ghostLowLabel = na
var line bslLine = na
var line sslLine = na

if i_showPacMan and barstate.islast
    if not na(ghostHighLabel)
        label.delete(ghostHighLabel)
    if not na(ghostLowLabel)
        label.delete(ghostLowLabel)
    if not na(bslLine)
        line.delete(bslLine)
    if not na(sslLine)
        line.delete(sslLine)

    // BSL - Ghost hunting highs with eyes ğŸ‘»
    bslLine := line.new(bar_index - 20, high60IPDA, bar_index + 5, high60IPDA,
         color=color.new(#FF5252, 60), width=1, style=line.style_dotted)
    ghostHighLabel := label.new(bar_index + 6, high60IPDA, "ğŸ‘» BSL",
         style=label.style_none, textcolor=color.new(#FF5252, 20), size=size.small)

    // SSL - Ghost hunting lows with eyes ğŸ‘»
    sslLine := line.new(bar_index - 20, low60IPDA, bar_index + 5, low60IPDA,
         color=color.new(#69F0AE, 60), width=1, style=line.style_dotted)
    ghostLowLabel := label.new(bar_index + 6, low60IPDA, "ğŸ‘» SSL",
         style=label.style_none, textcolor=color.new(#69F0AE, 20), size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPOSITE TIER SIGNALS (Only on TRUE high-confluence events)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Tier 1 requires ACTUAL confluence events, not just high probability
// Must have at least one of these triggers: Model2022, TurtleSoup, Judas, or CHoCH
hasTriggerEvent = model2022Bull or model2022Bear or bullishTS or bearishTS or bullishJudas or bearishJudas or bullishCHoCH or bearishCHoCH

tier1Bull = i_showComposite and compositeTier == TIER_1 and dolDirection == DIR_BULL and hasTriggerEvent
tier1Bear = i_showComposite and compositeTier == TIER_1 and dolDirection == DIR_BEAR and hasTriggerEvent
tier2Bull = i_showComposite and compositeTier == TIER_2 and dolDirection == DIR_BULL
tier2Bear = i_showComposite and compositeTier == TIER_2 and dolDirection == DIR_BEAR

// Tier 1 signals - clean badge style (only on trigger events)
plotshape(tier1Bull and barstate.isconfirmed, title="Tier 1 Bull", style=shape.labelup,
     location=location.belowbar, color=color.new(#00C853, 0), text="T1", textcolor=color.white, size=size.small)
plotshape(tier1Bear and barstate.isconfirmed, title="Tier 1 Bear", style=shape.labeldown,
     location=location.abovebar, color=color.new(#FF1744, 0), text="T1", textcolor=color.white, size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOL PROBABILITY DASHBOARD (GOD MODE INFO TABLE) - SLEEK ARCADE DESIGN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Sleek dark arcade background colors
var color tableBg = color.new(#0D0D0D, 5)
var color tableBgAlt = color.new(#1A1A2E, 10)
var color headerBg = color.new(#16213E, 0)
var color accentLine = color.new(#0F3460, 0)
var color textDim = color.new(#8892B0, 0)
var color textBright = color.new(#E6F1FF, 0)

var table infoTable = table.new(position.middle_right, 2, 14, bgcolor=tableBg, border_width=0, border_color=color.new(#1A1A2E, 50), frame_width=2, frame_color=color.new(#0F3460, 30))

if i_showDOLTable and barstate.islast
    // â•â•â• HEADER - Sleek title bar â•â•â•
    table.cell(infoTable, 0, 0, "â—‰ PAC-MAN STATUS", text_color=i_pacmanColor, text_size=size.normal, bgcolor=headerBg, text_halign=text.align_center)
    table.cell(infoTable, 1, 0, str.tostring(dolProbability, "#") + "%", text_color=dolProbability >= 70 ? i_bullColor : dolProbability >= 50 ? i_neutralColor : i_bearColor, text_size=size.normal, bgcolor=headerBg, text_halign=text.align_center)

    // â•â•â• DIRECTION ROW - Main signal â•â•â•
    dirText = dolDirection == DIR_BULL ? "â–² LONG" : dolDirection == DIR_BEAR ? "â–¼ SHORT" : "â—† NEUTRAL"
    dirColor = dolDirection == DIR_BULL ? i_bullColor : dolDirection == DIR_BEAR ? i_bearColor : i_neutralColor
    dirBg = dolDirection == DIR_BULL ? color.new(i_bullColor, 85) : dolDirection == DIR_BEAR ? color.new(i_bearColor, 85) : color.new(i_neutralColor, 90)
    table.cell(infoTable, 0, 1, dirText, text_color=dirColor, text_size=size.normal, bgcolor=dirBg, text_halign=text.align_center)
    table.merge_cells(infoTable, 0, 1, 1, 1)

    // â•â•â• BIAS ALIGNMENT â•â•â•
    htfIcon = htfBias == DIR_BULL ? "â—" : htfBias == DIR_BEAR ? "â—" : "â—‹"
    htfColor = htfBias == DIR_BULL ? i_bullColor : htfBias == DIR_BEAR ? i_bearColor : textDim
    msIcon = msDirection == DIR_BULL ? "â—" : msDirection == DIR_BEAR ? "â—" : "â—‹"
    msColor = msDirection == DIR_BULL ? i_bullColor : msDirection == DIR_BEAR ? i_bearColor : textDim
    aligned = (htfBias == msDirection and htfBias != 0)
    table.cell(infoTable, 0, 2, "HTF " + htfIcon + "  MS " + msIcon, text_color=aligned ? i_bullColor : textDim, text_size=size.small, bgcolor=tableBgAlt, text_halign=text.align_left)
    table.cell(infoTable, 1, 2, aligned ? "ALIGNED" : "â€”", text_color=aligned ? i_bullColor : textDim, text_size=size.small, bgcolor=tableBgAlt, text_halign=text.align_right)

    // â•â•â• ZONE â•â•â•
    zoneText = inPremium ? "PREMIUM â–²" : inDiscount ? "DISCOUNT â–¼" : inOTE ? "â—‰ OTE" : "EQUILIBRIUM"
    zoneColor = inPremium ? i_bearColor : inDiscount ? i_bullColor : inOTE ? color.new(#00BCD4, 0) : textDim
    zoneBg = inOTE ? color.new(#00BCD4, 90) : tableBg
    table.cell(infoTable, 0, 3, "Zone", text_color=textDim, text_size=size.tiny, bgcolor=zoneBg, text_halign=text.align_left)
    table.cell(infoTable, 1, 3, zoneText, text_color=zoneColor, text_size=size.small, bgcolor=zoneBg, text_halign=text.align_right)

    // â•â•â• PATTERN NAME - Featured â•â•â•
    patternColor = compositeTier == TIER_1 ? i_bullColor : compositeTier == TIER_2 ? i_neutralColor : textDim
    patternBg = compositeTier == TIER_1 ? color.new(i_bullColor, 88) : tableBgAlt
    cleanPattern = str.replace_all(str.replace_all(str.replace_all(patternName, "ğŸ† ", ""), "ğŸ¥ˆ ", ""), "ğŸ¥‰ ", "")
    table.cell(infoTable, 0, 4, cleanPattern, text_color=patternColor, text_size=size.small, bgcolor=patternBg, text_halign=text.align_center)
    table.merge_cells(infoTable, 0, 4, 1, 4)

    // â•â•â• TURTLE SOUP STAGE â•â•â•
    tsText = tsStage == "STALK_HIGH" or tsStage == "STALK_LOW" ? "â— STALK" : tsStage == "TRAP" ? "â—‰ TRAP" : tsStage == "CONFIRM_BULL" or tsStage == "CONFIRM_BEAR" ? "âœ“ CONFIRM" : tsStage == "INVALID" ? "âœ— INVALID" : "â€”"
    tsColor = tsStage == "CONFIRM_BULL" or tsStage == "CONFIRM_BEAR" ? i_bullColor : tsStage == "TRAP" ? i_liqColor : tsStage == "STALK_HIGH" or tsStage == "STALK_LOW" ? i_neutralColor : textDim
    table.cell(infoTable, 0, 5, "Turtle Soup", text_color=textDim, text_size=size.tiny, bgcolor=tableBg, text_halign=text.align_left)
    table.cell(infoTable, 1, 5, tsText, text_color=tsColor, text_size=size.small, bgcolor=tableBg, text_halign=text.align_right)

    // â•â•â• PO3 PHASE â•â•â•
    po3Short = po3Phase == "ACCUMULATION" ? "ACC" : po3Phase == "MANIPULATION" ? "MAN" : "DIST"
    po3Color = po3Phase == "DISTRIBUTION" ? i_bullColor : po3Phase == "MANIPULATION" ? i_liqColor : textDim
    table.cell(infoTable, 0, 6, "PO3", text_color=textDim, text_size=size.tiny, bgcolor=tableBgAlt, text_halign=text.align_left)
    table.cell(infoTable, 1, 6, po3Short, text_color=po3Color, text_size=size.small, bgcolor=tableBgAlt, text_halign=text.align_right)

    // â•â•â• SESSION / KILLZONE â•â•â•
    sessText = asianSession ? "ASIA" : londonSession ? "LON" : nyAMSession ? "NY-AM" : nyPMSession ? "NY-PM" : "OFF"
    kzActive = inSilverBullet or nyAMKZ or nyPMKZ or londonKZ
    kzText = inSilverBullet ? "â—‰ SB" : kzActive ? "â—‰ KZ" : ""
    sessColor = kzActive ? i_bullColor : textDim
    table.cell(infoTable, 0, 7, sessText, text_color=sessColor, text_size=size.small, bgcolor=tableBg, text_halign=text.align_left)
    table.cell(infoTable, 1, 7, kzText, text_color=inSilverBullet ? color.new(#00E5FF, 0) : i_bullColor, text_size=size.small, bgcolor=tableBg, text_halign=text.align_right)

    // â•â•â• CONFLUENCE COUNT â•â•â•
    confDots = confluenceCount >= 6 ? "â—â—â—â—â—â—" : confluenceCount >= 5 ? "â—â—â—â—â—â—‹" : confluenceCount >= 4 ? "â—â—â—â—â—‹â—‹" : confluenceCount >= 3 ? "â—â—â—â—‹â—‹â—‹" : confluenceCount >= 2 ? "â—â—â—‹â—‹â—‹â—‹" : "â—â—‹â—‹â—‹â—‹â—‹"
    confColor = confluenceCount >= 5 ? i_bullColor : confluenceCount >= 3 ? i_neutralColor : textDim
    table.cell(infoTable, 0, 8, "Confluence", text_color=textDim, text_size=size.tiny, bgcolor=tableBgAlt, text_halign=text.align_left)
    table.cell(infoTable, 1, 8, confDots, text_color=confColor, text_size=size.small, bgcolor=tableBgAlt, text_halign=text.align_right)

    // â•â•â• WEEKLY PROFILE & S&D â•â•â•
    wpText = weeklyProfile == "ACCUMULATION" ? "ACC" : weeklyProfile == "MANIPULATION" ? "MAN" : "DIST"
    wpColor = weeklyProfile == "DISTRIBUTION" ? i_bullColor : weeklyProfile == "MANIPULATION" ? i_liqColor : textDim
    sdText = sdPhase == "DESTROY_BEARS" ? "âš¡ BEARS" : sdPhase == "DESTROY_BULLS" ? "âš¡ BULLS" : sdPhase == "SEEK" ? "â— SEEK" : sdPhase == "WATCH" ? "â— S&D" : "â€”"
    sdColor = sdPhase == "DESTROY_BEARS" or sdPhase == "DESTROY_BULLS" ? i_bullColor : sdPhase == "SEEK" or sdPhase == "WATCH" ? i_liqColor : textDim
    table.cell(infoTable, 0, 9, wpText + " " + quarterName, text_color=wpColor, text_size=size.small, bgcolor=tableBg, text_halign=text.align_left)
    table.cell(infoTable, 1, 9, sdText, text_color=sdColor, text_size=size.small, bgcolor=tableBg, text_halign=text.align_right)

    // â•â•â• ORG (Opening Range Gap) â•â•â•
    orgText = hasORG ? "â—‰ GAP" : "â€”"
    orgColor = hasORG ? color.new(#FF9800, 0) : textDim
    table.cell(infoTable, 0, 10, "ORG", text_color=textDim, text_size=size.tiny, bgcolor=tableBgAlt, text_halign=text.align_left)
    table.cell(infoTable, 1, 10, orgText, text_color=orgColor, text_size=size.small, bgcolor=tableBgAlt, text_halign=text.align_right)

    // â•â•â• KEY FACTORS - Compact â•â•â•
    table.cell(infoTable, 0, 11, dolReason, text_color=textDim, text_size=size.tiny, bgcolor=tableBg, text_halign=text.align_center)
    table.merge_cells(infoTable, 0, 11, 1, 11)

    // â•â•â• TARGET â•â•â•
    table.cell(infoTable, 0, 12, "Target", text_color=textDim, text_size=size.tiny, bgcolor=tableBgAlt, text_halign=text.align_left)
    table.cell(infoTable, 1, 12, str.tostring(dolTarget, format.mintick), text_color=dirColor, text_size=size.small, bgcolor=tableBgAlt, text_halign=text.align_right)

    // â•â•â• TIER INDICATOR BAR â•â•â•
    tierBar = compositeTier == TIER_1 ? "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ" : compositeTier == TIER_2 ? "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘" : "â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘"
    tierColor = compositeTier == TIER_1 ? i_bullColor : compositeTier == TIER_2 ? i_neutralColor : textDim
    table.cell(infoTable, 0, 13, tierBar, text_color=tierColor, text_size=size.tiny, bgcolor=headerBg, text_halign=text.align_center)
    table.merge_cells(infoTable, 0, 13, 1, 13)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS (Reduced to stay under 64 plot limit)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Tier 1 alerts (most important)
alertcondition(tier1Bull, title="ğŸ† Tier 1 Long", message="ğŸ† TIER 1 LONG SETUP on {{ticker}} - Maximum confluence!")
alertcondition(tier1Bear, title="ğŸ† Tier 1 Short", message="ğŸ† TIER 1 SHORT SETUP on {{ticker}} - Maximum confluence!")

// 2022 Model alerts
alertcondition(model2022Bull, title="ğŸ“š 2022 Model Long", message="ğŸ“š 2022 MODEL LONG on {{ticker}} - Sweep + Displacement + FVG")
alertcondition(model2022Bear, title="ğŸ“š 2022 Model Short", message="ğŸ“š 2022 MODEL SHORT on {{ticker}} - Sweep + Displacement + FVG")

// Plot probability for external use
plot(dolProbability, title="DOL Probability", display=display.none)
plot(dolDirection, title="DOL Direction", display=display.none)
plot(compositeTier, title="Composite Tier", display=display.none)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END OF ATLAS ICT PRO v5.0 - GOD MODE [PAC-MAN EDITION]
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// Total ICT Concepts Integrated from The Cortex:
// 1. Market Structure (BOS/CHoCH) - 8,016 mentions
// 2. Liquidity (BSL/SSL/EQH/EQL) - 7,892 mentions
// 3. Premium/Discount Zones - 6,234 mentions
// 4. Order Blocks with Lifecycle - 5,891 mentions
// 5. Fair Value Gaps (FVG/IFVG) - 4,567 mentions
// 6. OTE Zone (62-79%) - 4,123 mentions
// 7. Killzones - 3,892 mentions
// 8. Silver Bullet Windows - 3,456 mentions
// 9. Power of Three (AMD) - 3,234 mentions
// 10. 2022 Model - 2,891 mentions
// 11. Turtle Soup - 2,567 mentions
// 12. Judas Swing - 2,345 mentions
// 13. Displacement - 2,123 mentions
// 14. IPDA Data Ranges - 1,892 mentions
// 15. Midnight Open/True Day - 1,678 mentions
// 16. CBDR - 1,456 mentions
// 17. NWOG - 1,234 mentions
// 18. HTF Bias Alignment - Custom weight
// 19. Composite Scoring (Tier 1/2/3) - Custom system
//
// PAC-MAN THEME ELEMENTS:
// ğŸŸ¡ PAC-MAN = Current price position
// ğŸ‘» GHOSTS = Institutional liquidity targets (BSL/SSL)
// âš« PELLETS = Equal Highs/Lows (small liquidity)
// ğŸŒ€ SPAWN ZONE = OTE retracement area
// ğŸ¯ MAZE PATH = DOL direction arrow
// ğŸ BONUS = NWOG zones
// ğŸ† TIER MEDALS = Composite confluence signals
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
